#!/bin/bash
#/ passm: password manager
#/
#/ passm sync <entry> - sync pass and lpass
#/
#/ Environment variables used:
#/ - LPASS_USERNAME

# TODO: Display usage if LPASS_USERNAME is missing

usage () {
  cat $0 | tail -n +2 | grep "^#/" | cut -c4-
  exit 1
}

if [ $# -eq 0 ]; then
  usage
fi

TMPFILE=$(mktemp /tmp/passm.XXXXXX)
COMMAND=$1
shift

case $COMMAND in
  sync)
    lpass ls 2>&1 | tee $TMPFILE >/dev/null
    LPASS_STATUS=$(cat $TMPFILE)
    if [[ $LPASS_STATUS =~ "Could not find decryption key" ]]; then
      lpass login $LPASS_USERNAME
    fi
    wallet=$(cat <(lpass export))
    entry=$1

    # is there an entry?
    if echo "$wallet" | grep -q $entry; then
      echo "Existing!"
      ## edit it if necessary
    else
      # TODO: Parse from $wallet
      password=$(pass show web/$entry | head -1)
      username=$(pass show web/$entry | grep username | cut -d ' ' -f2)
      url=$(pass show web/$entry | grep url | cut -d ' ' -f2)
      name=$(echo $entry | sed 's/http:\/\///' | sed 's/www\.//')
      echo $url | lpass edit --non-interactive --url $name
      lpass sync
      uid=$(lpass ls | grep $name | cut -d ' ' -f3 | rev | cut -c2- | rev)
      echo $username | lpass edit --non-interactive --username $uid
      echo $password | lpass edit --non-interactive --password $uid
    fi
    ;;
  *)
    usage
esac

rm -f $TMPFILE
